---
title: "EnWAS Base Model: Diasatolic-Blood Pressure"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types

```

## Query Extra data 
This part loads the blood pressure data and merges it with the dietary and demographic data in the above section.

```{r query, echo=TRUE}
nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# demo <- dbGetQuery(nhanes_db, "select * from demo")
# cholesterol <- dbGetQuery(nhanes_db, "select * from cholesterol")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI1 <> 0")
dbDisconnect(nhanes_db)

```

## BPXDI1 - Diastolic: Blood pres (1st rdg) mm Hg

This section compares linear and spline regression of Diastolic blood pressure against age and BMI.

```{r BPXDI1, echo=TRUE,warning=FALSE}
library(ggpubr)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))

g1 <- ggplot(data,
         aes(
           x = RIDAGEYR,
           y = BPXDI1,
           colour = RIAGENDR
         )) +
  geom_point(alpha = 0.1) +
  geom_smooth(
    method = lm,
    formula = y ~ ns(x, knots = seq(20, 80, by = 5)),
    size = 1
  )+
  geom_smooth(method = lm, formula = y ~ x)

g2 <- ggplot(data,
         aes(
           x = invNorm(RIDAGEYR),
           y = BPXDI1,
           colour = RIAGENDR
         )) +
  geom_point(alpha = 0.1) +
  geom_smooth(
    method = lm,
    formula = y ~ ns(x, knots = seq(20, 80, by = 5)),
    size = 1
  )+
  geom_smooth(method = lm, formula = y ~ x)


g3 <- ggplot(data, aes(x=BMXBMI, y=BPXDI1) ) + 
  geom_point(aes(colour=RIAGENDR),alpha=0.1)+
  geom_density_2d()+geom_smooth(method = lm,formula = y ~ ns(x,df=7))+
  geom_smooth(method = lm, formula = y ~ x)

g4 <- ggplot(data, aes(x=BMXBMI, y=invNorm(BPXDI1))) + 
  geom_point(aes(colour=RIAGENDR),alpha=0.1)+
  geom_density_2d()+geom_smooth(method = lm,formula = y ~ ns(x,df=7))+
  geom_smooth(method = lm, formula = y ~ x)

```


As shown in the below plots, the Diastolic has a parabola-like relation with age. The left shows the regressions without raw Diastolic values, and Diastolic values have transformed with inverse normal transformation in the second plot. The inverse normal transformation shows a better scale and reveal the differences. The linear regression model has a significant residual overall, performing even worse for participants younger than 30 and older than 70.
Therefore, apply linear regression could miss leading in EnWAS.



```{r BPXDI12, echo=TRUE,warning=FALSE,out.width = '90%'}
ggarrange(g1,g2,common.legend = TRUE)

```


Similarly, the following two plots show Diastolic with respect to BMI. Although the spline and linear regressions are very close in this case, they still have some divergence at the early and late age. It may accept to use linear regression on BMI, but spline still would improve the accuracy. Note that the gender does not make much difference in this model.


```{r BPXDI13, echo=TRUE,warning=FALSE,out.width = '90%'}
ggarrange(g3,g4,common.legend = TRUE)

```


## Base Model

```{r func3, echo=TRUE,warning=F, out.width = '90%'}
linear_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI'
all_ns_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10)))'

```

## Plot residuals

```{r enthic, echo=TRUE,results = "asis"}
ethnicity <-
  c(
    'Mexican American',
    'Other Hispanic',
    'Non-Hispanic White',
    'Non-Hispanic Black',
    'Other Race'
  )
lm_base <- lm(as.formula(linear_model), data)
# summary(lm_base)


lm_df <-
  data.frame(
    residuals = lm_base$residual,
    ethnicity = data$RIDRETH1,
    gender = data$RIAGENDR,
    years = data$years,
    model = "lm"
  )
ns_base <- lm(as.formula(all_ns_model), data)
# summary(ns_base)
ns_df <-
  data.frame(
    residuals = ns_base$residual,
    ethnicity = data$RIDRETH1,
    gender = data$RIAGENDR,
    years = data$years,
    model = "ns"
  )
levels(ns_df$ethnicity) <- ethnicity

```


The following plot shows the compassion of residuals across ethnic groups. The Non-Hispanic Black and Non-Hispanic White are slightly different from the rest of groups.

```{r enthic2, echo=TRUE,results = "asis"}

ggplot(ns_df, aes(x = ethnicity, y = residuals, fill = gender)) + geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 45))
```


We also notice that the residuals across the years are almost the same, indicating that we can combine the data and analysis over the years.

```{r resid2, echo=TRUE,results = "asis"}
ggplot(ns_df, aes(x = years, y = residuals, fill = gender)) + geom_boxplot() +
  scale_x_discrete(guide = guide_axis(angle = 45))
```

## Residual ~ Age

We plotted scatter plots of residuals from the linear regression and spline regression against age to verify the base models. As we can see from the smoothed scatter plots, the residuals from the linear model have a clear trend with age, which indicates the model does not capture the age pattern, whereas the residuals from the spline model have no obvious pattern. Therefore, spline regression (other non-linear functions) is necessary to capture the age trend.


```{r resid2_age, echo=TRUE,results = "asis"}
par(mfrow=c(1,2))
smoothScatter(data$RIDAGEYR,lm_base$residuals,
              nrpoints=100,pch = 10, col = "red")
smoothScatter(data$RIDAGEYR,ns_base$residuals,
              nrpoints=100,pch = 10, col = "red")
```




## Bins Plot

The following implement function plot by bins



```{r residual1, echo=TRUE,warning=FALSE,message=FALSE,results = "asis"}
bin_mean <- function(bin){
  bin <- stringi::stri_replace_all_fixed(as.character(bin),'(','')
  bin <- stringi::stri_replace_all_fixed(as.character(bin),']','')
  bin <- as.numeric(unlist(stringi::stri_split_coll(bin,",")))
  mean(bin)
}

plot_bins<- function(x,y,xlab="bin avg",ylab="residuals",title="linear",nbin=100){
  if (nbin==0)
    nbin <- floor(sqrt(length(x)))
  
  df <-
  data.frame(
    y = y,
    breaks = cut(x,breaks = nbin)
  )
  df <- df %>% 
  group_by(breaks) %>% 
  summarize(mean = mean(y),
            std = sd(y)
            ) %>% mutate(y_min=mean-std, y_max = mean+std)
  df$bin_avg <- sapply(df$breaks, bin_mean)
  
  
  g <- ggplot(df,aes(bin_avg,mean)) + geom_point() +
  # geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(bin_avg,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) + labs(title = title)

g

  
}


```



## Bins Residual Plot

The following plots show the residuals binned and plotted with respect to BMI ($kg/m^2$) and age. 
Each bin contains about 150 data points on average. The number of data points in each could be very different, as we can see from the distributions of the AGE and BMI. We have fewer participants who are older than 70. Similarly, most participants' BMI is between 20-40, meaning the bins in this range contain more data points than other bins; especially, the number of participants with BMI in the range of 50-80 is much less than the rest.


```{r residual12, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
age_dist <- ggplot(data=data, aes(x=RIDAGEYR, group=RIAGENDR, fill=RIAGENDR)) +
    geom_density(adjust=1.5, alpha=.25)
bmi_dist <- ggplot(data=data, aes(x=BMXBMI, group=RIAGENDR, fill=RIAGENDR)) +
    geom_density(adjust=1.5, alpha=.25)
ggarrange(age_dist,bmi_dist,common.legend = TRUE)
```

The residuals of the linear regression against age have an apparent trend (parabola-like shape), and residuals of spline regression have no apparent tendency. In other words, the non-linear relationship was not explained by the the linear regression and was left out in the residuals. The residuals of the spline model have significant for the participant older than 70 because we have fewer participants for those age groups.


There are fewer data points when BMI is greater than 50, which makes the residual considerably large and vary. However, we do not see a noticeable tendency in both models, indicating that linear and spline regressions for diastolic against BMI are very similar.

```{r residual122, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
lm_bmi <- plot_bins(data$BMXBMI, lm_base$residuals,xlab="BMI(kg/m²)",nbin=200)
ns_bmi <- plot_bins(data$BMXBMI, ns_base$residuals,xlab="BMI(kg/m²)",title="spline",nbin=200)
lm_age <- plot_bins(data$RIDAGEYR, lm_base$residuals,xlab="Age",nbin=200)
ns_age <- plot_bins(data$RIDAGEYR, ns_base$residuals,xlab="Age",title="spline",nbin=200)

ggarrange(lm_age,ns_age,lm_bmi,ns_bmi,ncol = 2,nrow = 2,common.legend = TRUE)

```

## Scale-Location

The following plots show spread points equally (randomly) along the horizontal line, which indicates equal variance (homoscedasticity).

```{r Scale, echo=TRUE,warning=FALSE,message=FALSE,results = "asis"}
par(mfrow=c(1,2))
plot(lm_base, which = 3,main = "Linear")
plot(ns_base, which = 3,main = "Spline")
```



A clear versions of the above plots with bins.

```{r Scale1, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
library(latex2exp)
std_g_lm <- plot_bins(
  lm_base$fitted.values,
  rstandard(lm_base),
  xlab = "fitted value",
  ylab = TeX(r'($\sqrt{|standardize\ residuals|}$)'),
  nbin = 200
)
std_g_ns <- plot_bins(
  ns_base$fitted.values,
  rstandard(ns_base),
  xlab = "fitted value",
  ylab = TeX(r'($\sqrt{|standardize\ residuals|}$)'),
  title="spline",
  nbin = 200
)

ggarrange(std_g_lm, std_g_ns,common.legend = TRUE)
```



## Residuals vs Leverage
Leverage for linear regression:
$$
\frac{1}{n}+\frac{\left(X_{i}-\bar{X}\right)^{2}}{S S_{X X}}
$$
Influence: Cook's distance 

As we can see from the lower left corner, some outliers are influential in linear regression.
There are no obvious outliers in the spline regression. 


```{r Leverage, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
par(mfrow=c(1,2))
plot(lm_base, which = 5,main = "Linear")
plot(ns_base, which = 5,main = "Spline")
```


Further, we can filter out the outliers defined by their Cook's distance greater than 5 times the mean of Cook's distance.
And we can find that the dataset has a very different distribution from the whole data set. First, most participants are older than 80 and younger than 40. Second, the Diastolic-Blood Pressure distributions are like parabola concave up, whereas the whole data set is like a bell curve distribution (parabola concave down shape).

```{r Leverage2, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
lm_cooks_ds <- cooks.distance(lm_base)
lm_influential <- lm_cooks_ds[(lm_cooks_ds > (5 * mean(lm_cooks_ds, na.rm = TRUE)))]

ns_cooks_ds <- cooks.distance(ns_base)
ns_influential <- ns_cooks_ds[(ns_cooks_ds > (5 * mean(ns_cooks_ds, na.rm = TRUE)))]

p_lm <- ggplot(data=data[names(lm_influential),], aes(x=BPXDI1, group=RIAGENDR, fill=RIAGENDR)) +
  geom_density(adjust=1.5, alpha=.25)+labs(title = "linear")
p_lm2 <- ggplot(data=data[names(lm_influential),], aes(x=RIDAGEYR, group=RIAGENDR, fill=RIAGENDR)) +
  geom_density(adjust=1.5, alpha=.25)+labs(title = "linear")
p_ns <- ggplot(data=data[names(ns_influential),], aes(x=BPXDI1, group=RIAGENDR, fill=RIAGENDR)) +
  geom_density(adjust=1.5, alpha=.25)+labs(title = "spline")
p_ns2 <- ggplot(data=data[names(ns_influential),], aes(x=RIDAGEYR, group=RIAGENDR, fill=RIAGENDR)) +
  geom_density(adjust=1.5, alpha=.25)+labs(title = "spline")

ggarrange(p_lm, p_ns,p_lm2,p_ns2,ncol = 2,nrow = 2, common.legend = TRUE)
```

By removing these two outliers from the linear regression, the $R^2$ change from 0.03276 to 0.03449 for linear regression , and 0.1273 to 0.08406 for spline regression

```{r Leverage3, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}
lm_base1 <- lm(as.formula(linear_model), data[names(lm_influential),])
ns_base1 <- lm(as.formula(all_ns_model), data[names(ns_influential),])
par(mfrow=c(1,2))
plot(lm_base1, which = 5,main = "Linear")
plot(ns_base1, which = 5,main = "Spline")
```

###  Cook's distance and leverage bin plots

```{r Leverage4, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}

lm_cook_age <- plot_bins(
  data$RIDAGEYR,
  cooks.distance(lm_base),
  xlab = "Age",
  ylab = "Cook's Distance",
  nbin = 500
)
ns_cook_age <- plot_bins(
  data$RIDAGEYR,
  cooks.distance(ns_base),
  xlab = "Age",
  ylab = "Cook's Distance",
  title="spline",
  nbin = 500
)


lm_cook_bmi <- plot_bins(
  data$BMXBMI,
  cooks.distance(lm_base),
  xlab = "BMI",
  ylab = "Cook's Distance",
  nbin = 500
)
ns_cook_bmi <- plot_bins(
  data$BMXBMI,
  cooks.distance(ns_base),
  xlab = "BMI",
  ylab = "Cook's Distance",
  title="spline",
  nbin = 500
)

# ggarrange(lm_cook_age,ns_cook_age,lm_cook_bmi,ns_cook_bmi,common.legend = TRUE)

lev_lm_age <- plot_bins(
  data$RIDAGEYR,
  hatvalues(lm_base),
  xlab = "Age",
  ylab = "Leverage",
  nbin = 500
)
lev_ns_age <- plot_bins(
  data$RIDAGEYR,
  hatvalues(ns_base),
  xlab = "Age",
  ylab = "Leverage",
  title="spline",
  nbin = 500
)



lev_lm_bmi <- plot_bins(
  data$BMXBMI,
  hatvalues(lm_base),
  xlab = "BMI",
  ylab = "Leverage",
  nbin = 500
)
lev_ns_bmi <- plot_bins(
  data$BMXBMI,
  hatvalues(ns_base),
  xlab = "BMI",
  ylab = "Leverage",
  title="spline",
  nbin = 500
)


# ggarrange(lev_lm_age, lev_ns_age,lev_lm_bmi,lev_ns_bmi,common.legend = TRUE)


```



As we can see from the bin plots, the participants who are younger ( < 40 ) or older (> 70) have high leverage and influence in the linear regression. On the other hand, the age variable does not have a significant impact on the spline regression model.

However, the data points with BMI above 60 have high leverage and influence in both models because it has much fewer data, as shown in the above plots. As the BMI has a linear relation with Diastolic-Blood Pressure, the data points with BMI less than 20 or greater than 40 have higher leverage and influence in the linear regression than in the spline regression. 

```{r Leverage5, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}

ggarrange(lm_cook_age,ns_cook_age,lm_cook_bmi,ns_cook_bmi,common.legend = TRUE)

```




```{r Leverage6, echo=TRUE,warning=FALSE,message=FALSE,results = "asis",dpi = 200}

ggarrange(lev_lm_age, lev_ns_age,lev_lm_bmi,lev_ns_bmi,common.legend = TRUE)

```



