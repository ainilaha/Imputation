---
title: "base_distolic_second_read"
date: "Updated on : `r date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)
library(Hmisc)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")

  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types

```

## Query Extra data 
This part loads the blood pressure data and merges it with the dietary and demographic data in the above section.

```{r query, echo=TRUE}
set.seed(123)
nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,BPXDI2,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI2 IS NOT NULL and BPXDI2 <> 0 and BPXDI1 <> 0")
dbDisconnect(nhanes_db)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))
data <- data[sample(1:nrow(data)), ] # shuffle the data
data$years <- as.factor(data$years)
```

## Base Model

```{r func3, echo=TRUE,warning=F, out.width = '90%'}
ns_str0 <-
  'BPXDI1 ~ ns(RIDAGEYR, knots = seq(30, 80, by = 10), Boundary.knots=c(20,90)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10)),Boundary.knots=c(10,85))'
ns_base0 <- lm(as.formula(ns_str0), data)

ns_str <-
  'BPXDI2 ~ ns(RIDAGEYR, knots = seq(30, 80, by = 10), Boundary.knots=c(20,90)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10)),Boundary.knots=c(10,85))'
ns_base <- lm(as.formula(ns_str), data)
```

## Bins plot functions


```{r plot_functions, echo=TRUE,warning=FALSE,message=FALSE,results = "asis"}
library(ggpubr)
library(reshape)

plot_bins<- function(x,y,xlab="Value",ylab="Binned Residuals",title="BPXDI1",nbin=600){

  df <- make_bins(x,y,nbin)
  g <- ggplot(df,aes(breaks,mean)) + geom_point() +
  geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(breaks,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) + labs(title = title)

 g

}



```


## BPXDI2 - Diastolic: Blood pres (2ed rdg) mm Hg

This section compares BPXDI1 and BPXDI2 regression of Diastolic blood pressure against age and BMI.

```{r BPXDI1, echo=TRUE,warning=FALSE}


pred_df <- data.frame("Age"=data$RIDAGEYR,
                      "Gender"=data$RIAGENDR,
                      "BMI"=data$BMXBMI,
                      "BPXDI1"=ns_base0$fitted.values,
                      "BPXDI2"=ns_base$fitted.values)



mpred_df <- reshape::melt(pred_df, id=c("Age","Gender",'BMI'))

fit_bmi <- ggplot(mpred_df, aes(x=BMI, y=value,colour=Gender) ) +
 geom_smooth() + geom_point(data = ~ group_by(.x, Age, Gender,variable) |> sample_frac(0.05),alpha=0.2)+
  facet_grid(cols = vars(variable))+ ylab("Fitted Values")+ xlab("BMI (kg/m²)")+
  theme_minimal()

fit_age <- ggplot(mpred_df, aes(x=Age, y=value,colour=Gender) ) +
 geom_smooth() + geom_point(data = ~ group_by(.x, Age, Gender,variable) |> sample_frac(0.05),alpha=0.2)+
  facet_grid(cols = vars(variable))+ylab("Fitted Values")+ xlab("Age (year)")+
  theme_minimal()


df_bmi_res <- list("BPXDI1"=make_bins(x=data$BMXBMI,ns_base0$residuals,nbin=600),
                "BPXDI2"=make_bins(x=data$BMXBMI,y=ns_base$residuals,nbin=600)
                )

df_age_res <- list("BPXDI1"=make_bins(x=data$RIDAGEYR,y=ns_base0$residual,nbin=600),
                "BPXDI2"=make_bins(x=data$RIDAGEYR,y=ns_base$residuals,nbin=600)
                )





bmi_res <- plot_bins2(df_bmi_res,xlab="BMI (kg/m²)",ylab="Binned Residuals") + xlim(min(data$BMXBMI),max(data$BMXBMI))
age_res <- plot_bins2(df_age_res,xlab="Age (year)",ylab="Binned Residuals") 



raw_age <- ggplot(data,
         aes(
           x = RIDAGEYR,
           y = BPXDI2
         )) +
  geom_point(data = ~ group_by(.x, RIDAGEYR, RIAGENDR,BMXBMI) |> sample_frac(0.5),
             alpha = 0.2, shape=1) + 
  geom_smooth(method = "lm",formula = y~x, aes(colour="BPXDI1"),size=1.5)+
  geom_smooth(method = "lm",formula = y~ns(x,df=7),aes(colour="BPXDI2"),size=1.5) +
  labs(colour="Gender")+
  xlab("Age (year)")+ylab("Diastolic (mm Hg)")+
   scale_colour_manual(name="Model", values=c("#E69F00", "#56B4E9"))+
  theme_minimal()

raw_bmi <- ggplot(data,
         aes(
           x = BMXBMI,
           y = BPXDI2,
        )) +
  geom_point(data = ~ group_by(.x, RIDAGEYR, RIAGENDR,BMXBMI) |> sample_frac(0.5),
             alpha = 0.2, shape=1) + 
  geom_smooth(method = "lm",formula = y~x, aes(colour="BPXDI1"),size=1.5)+
  geom_smooth(method = "lm",formula = y~ns(x,df=7),aes(colour="BPXDI2"),size=1.5) +
  labs(colour="Gender")+
  xlab("BMI (kg/m²)")+ylab("Diastolic (mm Hg)")+
   scale_colour_manual(name="Model", values=c("#E69F00", "#56B4E9"))+
  theme_minimal()


# ggpubr::ggarrange(raw_bmi,raw_age,bmi_res,age_res,common.legend = TRUE,labels = c('a','b','c','d'))


```

- <em><strong> a) </strong></em> and <em><strong> b) </strong></em> are the raw data with smooth fitted lines.

- <em><strong> c) </strong></em> and <em><strong> d) </strong></em> show fitted values of BPXDI1 and BPXDI2 regression against the BMI ($km/m^2$) and Age (years) colored by the gender of the participants. The lines show the relation between fitted values with BMI. For visibility, we sampled 5% of data with transparency (alpha=0.2) on the image.


- <em><strong> e) </strong></em> and <em><strong> f) </strong></em> show binned residuals against the BMI ($km/m^2$) and Age (years) colored by the models (BPXDI1 and BPXDI2 regression). The values on x-axis (BMI and Age) are binned, and each bin contains about 600 data points; further the mean of residuals are plotted with error bar ([$-1.96 \sqrt{\sigma_r},1.96\sqrt{\sigma_r}]$), where $\sqrt{\sigma_r}$ is the standard deviation of residuals in the bins. The binned residual can stretch the data point out so that it shows clear patterns of the residuals in each bin.

- <em><strong> c) </strong></em> and <em><strong> e) </strong></em> show that diastolic blood pressure does not have a strictly BPXDI1 relation with BMI. The binned residuals of BPXDI1 regression show a pattern, whereas there is no obvious trend or pattern for the BPXDI2 regression because the BPXDI2 model fits the non-BPXDI1ity relations.

- <em><strong> d) </strong></em> and <em><strong> f) </strong></em> show that the BPXDI1 regression model has a significant residual overall, performing even worse for participants younger than 30 and older than 70. Therefore, applying BPXDI1 regression could miss leading in EnWAS analysis.  Residuals of the BPXDI1 regression against age have an apparent trend (parabola-like shape), and residuals of BPXDI2 regression have no apparent tendency. In other words, the non-BPXDI1 relationship was not explained by BPXDI1 regression and was left out in the residuals.



```{r BPXDI12, echo=TRUE,warning=FALSE,message=FALSE, fig.width = 10,fig.height=10}
raw_g <- ggpubr::ggarrange(raw_bmi,raw_age,
                           common.legend = TRUE,
                           labels = c('a)','b)'),legend='right')

fit_g <- ggpubr::ggarrange(fit_bmi, fit_age,
                           common.legend = TRUE,
                           labels = c('c)','d)'),legend='right')


res_g <- ggpubr::ggarrange(bmi_res,age_res,common.legend = TRUE,labels = c('e)','f)'),legend='right')


ggpubr::ggarrange(raw_g,fit_g,res_g,nrow = 3,ncol = 1)




```
