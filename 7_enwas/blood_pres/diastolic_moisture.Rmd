---
title: "Diasatolic-Blood Pressure ~ Moisture"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html) and [Diastolic: EnWAS](https://ccb-hms.github.io/Imputation/7_enwas/blood_pres/blood_pres_diastolic.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)
library(ggpubr)
library(Hmisc)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types


nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# demo <- dbGetQuery(nhanes_db, "select * from demo")
# cholesterol <- dbGetQuery(nhanes_db, "select * from cholesterol")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI1 <> 0")
dbDisconnect(nhanes_db)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))

```




## DR1TMOIS - Moisture (0 to 18266.25 gm)

"Moisture in foods occurs in two forms: (1) water bound to ingredients in the food (proteins, salt, sugars), and (2) free or unbound water that is available for microbial growth. Water activity (Aw) describes water available for microbial growth and ranges from 0 (bone dry) to 1.0 (pure water)."
[more infor](https://www.clemson.edu/extension/food/canning/canning-tips/39available-moisture.html)

```{r resid22, echo=TRUE,message=FALSE,results = "asis"}


make_bins <- function(x,y,nbin){
  if (nbin==0)
    nbin <- floor(sqrt(length(x)))
  
  df <-
  data.frame(
    y = y,
    breaks = cut2(x,m=nbin,levels.mean=TRUE)
  )
  df <- df %>% 
  dplyr::group_by(breaks) %>% 
  dplyr::summarize(mean = mean(y),
            std = sd(y)
            ) %>% dplyr::mutate(y_min=mean-std, y_max = mean+std)
  
  df$breaks <- as.numeric(df$breaks)
  
  df

}

plot_bins<- function(x,y,xlab="bin avg",ylab="residuals",title="linear",nbin=100){

  df <- make_bins(x,y,nbin=100)
  g <- ggplot(df,aes(breaks,mean)) + geom_point() +
  # geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(breaks,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) + labs(title = title)

 g

  
}

linear_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI'

all_ns_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) '
lm_mos <- lm(as.formula(paste0(linear_model," + DR1TMOIS")), data)
ns_mos <- lm(as.formula(paste0(all_ns_model," + DR1TMOIS")), data)

lm_mos_age <- lm(BPXDI1 ~ RIDAGEYR*RIAGENDR*DR1TMOIS + BMXBMI, data)
ns_model_age <-
  'BPXDI1 ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR*DR1TMOIS + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) '
ns_mos_age <- lm(as.formula(ns_model_age), data)

```


###  Cook's distance and leverage bin plots

```{r cook_lev, echo=TRUE,message=FALSE,results = "asis",dpi = 200}

plot_bins2<- function(df_list,nbin=500,xlab = "Moisture",ylab = "Cook's Distance"){
  df <- do.call("rbind", df_list)
  df$EnWAS <-
  rep(names(df_list), each = nrow(df_list[[1]]))
    
  g <- ggplot(df,aes(bin_avg,mean,color=EnWAS)) + geom_point(alpha=0.2) +
  geom_smooth(aes(bin_avg,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) 
  g
  
}
df_list_cook <- list("Linear"=make_bins(x=data$DR1TMOIS,y=cooks.distance(lm_mos),nbin=500),
                "Spline"=make_bins(x=data$DR1TMOIS,y=cooks.distance(ns_mos),nbin=500),
                "lm(age:mos)"=make_bins(x=data$DR1TMOIS,y=cooks.distance(lm_mos_age),nbin=500)
                )

df_list_lev <- list("Linear"=make_bins(x=data$DR1TMOIS,y=hatvalues(lm_mos),nbin=500),
                "Spline"=make_bins(x=data$DR1TMOIS,y=hatvalues(ns_mos),nbin=500),
                "lm(age:mos)"=make_bins(x=data$DR1TMOIS,y=hatvalues(lm_mos_age),nbin=500)
                )
lev_g <- plot_bins2(df_list_lev,ylab = "Leverage")
cook_g <- plot_bins2(df_list_cook)



df_list_res <- list("Linear"=make_bins(x=data$DR1TMOIS,y=lm_mos$residuals,nbin=200),
                "Spline"=make_bins(x=data$DR1TMOIS,y=ns_mos$residuals,nbin=200),
                "lm(age:mos)"=make_bins(x=data$DR1TMOIS,lm_mos_age$residuals,nbin=200),
                "ns(age:mos)"=make_bins(x=data$DR1TMOIS,ns_mos_age$residuals,nbin=200)
                )

lev_g <- plot_bins2(df_list_lev,ylab = "Leverage")
cook_g <- plot_bins2(df_list_cook)
```

We compared the moisture impact on blood pressure with linear and spline regression.
[Jordan et al.](https://www.ahajournals.org/doi/pdf/10.1161/01.cir.101.5.504) suggest that water has the effect of increasing blood pressure in older
people; therefore, we also add models with moisture interacting with age for further comparison. The binned plots show all models have high leverage when DR1TMOIS greater than 1000, but they have less influence on the spline model than others. 

```{r cook_lev22, echo=TRUE,message=FALSE,results = "asis",dpi = 200}
ggarrange(lev_g,cook_g,common.legend = TRUE)

```

## Residuals ~ Moisture

It seems the spline regression models have larger residuals with respect to moisture than the linear regression models.

...

More water could reduce the high blood pressure, but sugar water makes it [worse...](https://www.medicinenet.com/can_drinking_water_lower_your_blood_pressure/article.htm)

```{r res, echo=TRUE,message=FALSE,results = "asis",dpi = 200}
plot_bins2(df_list_res,ylab = "residuals")

```











## Beta-carotene (0 to 116313 mcg): inverse normal transformation

"The human body converts beta carotene into vitamin A (retinol) â€“ beta carotene is a precursor of vitamin A. We need vitamin A for healthy skin and mucus membranes, our immune system, and good eye health and vision." [more](https://www.medicalnewstoday.com/articles/252758#what_is_carotene)


"If the residual distribution is asymmetric (skewed) or heavy-tailed (kurtotic) relative to the normal distribution, then standard linear regression may fail to control the type I error in moderate samples. Even if the sample is sufficiently large for standard linear regression to provide valid inference, it is not fully efficient when the residual distribution is non-normal. "
[more](https://cran.r-project.org/web/packages/RNOmni/vignettes/RNOmni.html)


As we can see from the below plots, the DR1TBCAR distribution is highly skewed and has a long tail before being transformed. On the other hand, the altered distribution has a typical normal distribution, which is very different from the original distribution.




