---
title: "EnWAS: Diasatolic-Blood Pressure"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types

```

## Query Extra data 

This part loads the blood pressure data and merges it with the dietary and demographic data in the above section.

```{r query, echo=TRUE}
nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# demo <- dbGetQuery(nhanes_db, "select * from demo")
# cholesterol <- dbGetQuery(nhanes_db, "select * from cholesterol")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI1 <> 0")
dbDisconnect(nhanes_db)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))

```


## Run EnWAS ( BPXDI1 - Diastolic: Blood pres (1st rdg) mm Hg )


To run the EnWAS for BPXDI1 against the dietary data, we use age, gender, and BMI as the adjusted variables and the adopted age and gender as interaction terms. To show the line regression may perform poorly and miss leading findings, we apply spline on the continuous variable in the base model. We choose to apply [natural spline](https://towardsdatascience.com/numerical-interpolation-natural-cubic-spline-52c1157b98ac) because it can keep relatively smoother than other spline methods when the regression close to the boundaries.


In addition, the EnWAS model can use inverse normal transformation on the wide association variables, which would be helpful to improve the models' performance when the distributions are skewed.

$$
\operatorname{INT}\left(W_{i}\right)=\Phi^{-1}\left\{\frac{\operatorname{rank}\left(W_{i}\right)-c}{n+1-2 c}\right\}, c \in[0,1 / 2]
$$ where c=3/8 is recommended.


```{r func3, echo=TRUE,warning=F, out.width = '90%'}
linear_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI'
linear_res2 <- enwas(linear_model, exposure_vars, data)

all_ns_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) '
all_ns_res <- enwas(all_ns_model, exposure_vars, data)


lm_inverse_res <- enwas(linear_model, exposure_vars, data,inv = TRUE)
ns_inverse_res <- enwas(all_ns_model, exposure_vars, data,inv = TRUE)


```


## Compare linear regression with spline regression.

The following plot shows the comparison of the estimation of dietary variables in the EnWAS. We have converted the estimate into the same scale.

$$Estimate \leftarrow Estimate \times std(X)$$ where X is the input variable.
$$Std.Error \leftarrow Std. Error \times std(X)$$


```{r res3, echo=TRUE,warning=F, out.width = '90%'}
# forest_plot(linear_res2$enwas_res)


forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    ns = all_ns_res$enwas_res
  )
)
```


```{r res4, echo=TRUE,warning=F, out.width = '90%'}

forest_plot_mult(
  list(
    ns = all_ns_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)

  
```


## Residuals

```{r resid2, echo=TRUE,message=FALSE,results = "asis"}


lm_base <- lm(as.formula(linear_model), data)
lm_df <-
  data.frame(
    residuals = lm_base$residual,
    gender = data$RIAGENDR,
    DR1TMOIS = data$DR1TMOIS,
    DR1TTFAT = data$DR1TTFAT
  )
ns_base <- lm(as.formula(all_ns_model), data)
ns_df <-
  data.frame(
    residuals = ns_base$residual,
    DR1TMOIS = data$DR1TMOIS,
    gender = data$RIAGENDR,
    DR1TTFAT = data$DR1TTFAT
  )


```


## DR1TMOIS - Moisture (0 to 18266.25 gm)

"Moisture in foods occurs in two forms: (1) water bound to ingredients in the food (proteins, salt, sugars), and (2) free or unbound water that is available for microbial growth. Water activity (Aw) describes water available for microbial growth and ranges from 0 (bone dry) to 1.0 (pure water)."
[more infor](https://www.clemson.edu/extension/food/canning/canning-tips/39available-moisture.html)

```{r resid22, echo=TRUE,message=FALSE,results = "asis"}
library(ggpubr)

bin_mean <- function(bin){
  bin <- stringi::stri_replace_all_fixed(as.character(bin),'(','')
  bin <- stringi::stri_replace_all_fixed(as.character(bin),']','')
  bin <- as.numeric(unlist(stringi::stri_split_coll(bin,",")))
  mean(bin)
}


make_bins <- function(x,y,nbin){
  if (nbin==0)
    nbin <- floor(sqrt(length(x)))
  
  df <-
  data.frame(
    y = y,
    breaks = cut(x,breaks = nbin)
  )
  df <- df %>% 
  group_by(breaks) %>% 
  summarize(mean = mean(y),
            std = sd(y)
            ) %>% mutate(y_min=mean-std, y_max = mean+std)
  df$bin_avg <- sapply(df$breaks, bin_mean)
  
  df
}

plot_bins<- function(x,y,xlab="bin avg",ylab="residuals",title="linear",nbin=100){

  df <- make_bins(x,y,nbin=100)
  g <- ggplot(df,aes(bin_avg,mean)) + geom_point() +
  # geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(bin_avg,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) + labs(title = title)

 g

  
}


lm_mos <- lm(as.formula(paste0(linear_model," + DR1TMOIS")), data)
ns_mos <- lm(as.formula(paste0(all_ns_model," + DR1TMOIS")), data)

```
###  Cook's distance and leverage bin plots
```{r cook_lev, echo=TRUE,message=FALSE,results = "asis",dpi = 200}

lm_cook_mos <- plot_bins(
  data$DR1TMOIS,
  cooks.distance(lm_mos),
  xlab = "Moisture",
  ylab = "Cook's Distance",
  nbin = 500
)
ns_cook_mos <- plot_bins(
  data$DR1TMOIS,
  cooks.distance(ns_mos),
  xlab = "Moisture",
  ylab = "Cook's Distance",
  title="spline",
  nbin = 500
)

lev_lm_mos <- plot_bins(
  data$DR1TMOIS,
  hatvalues(lm_mos),
  xlab = "Moisture",
  ylab = "Leverage",
  nbin = 500
)
lev_ns_mos <- plot_bins(
  data$DR1TMOIS,
  hatvalues(ns_mos),
  xlab = "Moisture",
  ylab = "Leverage",
  title="spline",
  nbin = 500
)
ggarrange(lev_lm_mos, lev_ns_mos,lm_cook_mos,ns_cook_mos,common.legend = TRUE)




plot_bins2<- function(df_list,nbin=500,xlab = "Moisture",ylab = "Cook's Distance"){
  df <- do.call("rbind", df_list)
  df$EnWAS <-
  rep(names(df_list), each = nrow(df_list[[1]]))
    
  g <- ggplot(df,aes(bin_avg,mean,color=EnWAS)) + geom_point() +
  geom_smooth(aes(bin_avg,mean),method = "lm", formula = y ~  ns(x, df=7))+
  ylab(ylab) + xlab(xlab) 
  g
  
}
df_list_cook <- list("Linear"=make_bins(x=data$DR1TMOIS,y=cooks.distance(lm_mos),nbin=500),
                "Spline"=make_bins(x=data$DR1TMOIS,y=cooks.distance(ns_mos),nbin=500)
                )

df_list_lev <- list("Linear"=make_bins(x=data$DR1TMOIS,y=hatvalues(lm_mos),nbin=500),
                "Spline"=make_bins(x=data$DR1TMOIS,y=hatvalues(ns_mos),nbin=500)
                )
lev_g <- plot_bins2(df_list_lev,ylab = "Leverage")
cook_g <- plot_bins2(df_list_cook)
ggarrange(lev_g,cook_g,common.legend = TRUE)
```

## Beta-carotene (0 to 116313 mcg): inverse normal transformation

"The human body converts beta carotene into vitamin A (retinol) â€“ beta carotene is a precursor of vitamin A. We need vitamin A for healthy skin and mucus membranes, our immune system, and good eye health and vision." [more](https://www.medicalnewstoday.com/articles/252758#what_is_carotene)


"If the residual distribution is asymmetric (skewed) or heavy-tailed (kurtotic) relative to the normal distribution, then standard linear regression may fail to control the type I error in moderate samples. Even if the sample is sufficiently large for standard linear regression to provide valid inference, it is not fully efficient when the residual distribution is non-normal. "
[more](https://cran.r-project.org/web/packages/RNOmni/vignettes/RNOmni.html)


As we can see from the below plots, the DR1TBCAR distribution is highly skewed and has a long tail before being transformed. On the other hand, the altered distribution has a typical normal distribution, which is very different from the original distribution.




