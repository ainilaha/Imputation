---
title: "Diasatolic-Blood Pressure ~ Moisture"
date: "Updated on : `r date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html) and [Diastolic: EnWAS](https://ccb-hms.github.io/Imputation/7_enwas/blood_pres/blood_pres_diastolic.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)
library(ggpubr)
library(Hmisc)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types


nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# demo <- dbGetQuery(nhanes_db, "select * from demo")
# cholesterol <- dbGetQuery(nhanes_db, "select * from cholesterol")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI1 <> 0")
dbDisconnect(nhanes_db)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))



```




## DR1TMOIS - Moisture (0 to 18266.25 gm)

"Moisture in foods occurs in two forms: (1) water bound to ingredients in the food (proteins, salt, sugars), and (2) free or unbound water that is available for microbial growth. Water activity (Aw) describes water available for microbial growth and ranges from 0 (bone dry) to 1.0 (pure water)."
[more infor](https://www.clemson.edu/extension/food/canning/canning-tips/39available-moisture.html)

```{r resid22, echo=TRUE,message=FALSE,results = "asis"}

make_bins <- function(x,y,nbin){
  if (nbin==0)
    nbin <- floor(sqrt(length(x)))
  
  df <-
  data.frame(
    y = y,
    breaks = cut2(x,m=nbin,levels.mean=TRUE)
  )
  df <- df %>% 
  dplyr::group_by(breaks) %>% 
  dplyr::summarize(mean = mean(y),
            std = sd(y),
            cnt = n()
            ) %>% dplyr::mutate(y_min=mean-1.96*std/sqrt(cnt), y_max = mean+1.96*std/sqrt(cnt))
  
  df$breaks <- as.numeric(as.character(df$breaks))
  
  df

}

plot_bins2<- function(df_list,xlab = "Moisture",ylab = "Binned Diff Residuals",title="DR1TMOIS"){
  df <- do.call("rbind", df_list)
  df$Model <-
  rep(names(df_list), each = nrow(df_list[[1]]))
    
  g <- ggplot(df,aes(breaks,mean,color=Model)) + geom_point() +
    geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(breaks,mean),se = FALSE)+
    scale_color_manual(values=c("#E69F00", "#56B4E9"))+
  ylab(ylab) + xlab(xlab) +ggtitle(title)+
  theme_minimal()
  g
  
}


linear_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI'

ns_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) '
lm_base <- lm(as.formula(linear_model), data)
ns_base <- lm(as.formula(ns_model), data)


lm_mos_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI+ DR1TMOIS '

ns_mos_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) + DR1TMOIS'
lm_mos <- lm(as.formula(lm_mos_model), data)
ns_mos <- lm(as.formula(ns_mos_model), data)




mos_age_res <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=abs(resid(lm_mos)-resid(lm_base)),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=abs(resid(ns_mos)-resid(ns_base)), 
                                   nbin=600)
                )



mos_bmi_res <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=abs(resid(lm_mos)-resid(lm_base)),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=abs(resid(ns_mos)-resid(ns_base)), 
                                   nbin=600)
                )


age_res_diff <- plot_bins2(mos_age_res,xlab="Age(years)") +ylim(0,0.32)

bmi_res_diff <- plot_bins2(mos_bmi_res,xlab="BMI (kg/m²)")+ylim(0,0.32)




lm_sug_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI+ DR1TCALC '
ns_sug_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) + DR1TCALC'
lm_fat <- lm(as.formula(lm_sug_model), data)
ns_fat <- lm(as.formula(ns_sug_model), data)

sug_age_res <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=abs(resid(lm_fat)-resid(lm_base)),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=abs(resid(ns_fat)-resid(ns_base)), 
                                   nbin=600)
                )



sug_bmi_res <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=abs(resid(lm_fat)-resid(lm_base)),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=abs(resid(ns_fat)-resid(ns_base)), 
                                   nbin=600)
                )


age_sug_diff <- plot_bins2(sug_bmi_res,xlab="Age(years)",title = "DR1TCALC")+ylim(0,0.32)

bmi_sug_diff <- plot_bins2(sug_bmi_res,xlab="BMI (kg/m²)",title = "DR1TCALC") +ylim(0,0.32)


```


###  absolute of the difference residuals with or without dietary variables

The following plots show the binned absolute of the difference residuals of models without (base model) or with dietary variables. It is another way to show how much the dietary variables affect the outputs. Including dietary variables in the models could improve the performance of the models or introduce noise, which can be detected with ANOVA LRT.    For example, the forest plot in the previous notebook shows the impacts of DR1TMOIS in linear regression and spline regression are pretty different. However, the spline model with DR1TMOIS and spline base model have almost the same performance, which means the DR1TMOIS may not be as important as shown in linear regression. On the other hand, adding DR1TCALC to linear or spline regression does not change much of the residuals.

```{r cook_lev, echo=TRUE,message=FALSE,results = "asis",dpi = 200}
ggpubr::ggarrange(bmi_res_diff,bmi_sug_diff,
                  age_res_diff,bmi_sug_diff,
                  common.legend = TRUE,legend="right")
```


We compared the moisture impact on blood pressure with linear and spline regression.
[Jordan et al.](https://www.ahajournals.org/doi/pdf/10.1161/01.cir.101.5.504) suggest that water has the effect of increasing blood pressure in older
people; therefore, we also add models with moisture interacting with age for further comparison. The binned plots show all models have high leverage when DR1TMOIS greater than 1000, but they have less influence on the spline model than others. 







## Beta-carotene (0 to 116313 mcg): inverse normal transformation

"The human body converts beta carotene into vitamin A (retinol) – beta carotene is a precursor of vitamin A. We need vitamin A for healthy skin and mucus membranes, our immune system, and good eye health and vision." [more](https://www.medicalnewstoday.com/articles/252758#what_is_carotene)


"If the residual distribution is asymmetric (skewed) or heavy-tailed (kurtotic) relative to the normal distribution, then standard linear regression may fail to control the type I error in moderate samples. Even if the sample is sufficiently large for standard linear regression to provide valid inference, it is not fully efficient when the residual distribution is non-normal. "
[more](https://cran.r-project.org/web/packages/RNOmni/vignettes/RNOmni.html)


As we can see from the below plots, the DR1TBCAR distribution is highly skewed and has a long tail before being transformed. On the other hand, the altered distribution has a typical normal distribution, which is very different from the original distribution.




