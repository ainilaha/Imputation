---
title: "Diasatolic-Blood Pressure ~ Moisture"
date: "Updated on : `r date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load libs and Load data
The process of load libs and data is the same as [EnWAS sample](https://ccb-hms.github.io/Imputation/7_enwas/EnWAS_simple.html) and [Diastolic: EnWAS](https://ccb-hms.github.io/Imputation/7_enwas/blood_pres/blood_pres_diastolic.html).

```{r data, warning=FALSE,message=FALSE,echo=FALSE}
# source("../6_nhanes_data/phesant.R")

library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)
library(ggpubr)
library(Hmisc)

exposure_vars <-
  read.delim("../../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
  
  cols <-
    'SEQN,BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, INDFMPIR, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types


nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")
# demo <- dbGetQuery(nhanes_db, "select * from demo")
# cholesterol <- dbGetQuery(nhanes_db, "select * from cholesterol")
# BPXDI2,BPXSY1
blood_pressure <- dbGetQuery(nhanes_db, "select SEQN,BPXDI1,years from blood_pressure where BPXDI1 IS NOT NULL and BPXDI1 <> 0")
dbDisconnect(nhanes_db)
data <- merge(blood_pressure, data, by = c("SEQN",'years'))



```




## DR1TMOIS - Moisture (0 to 18266.25 gm)

"Moisture in foods occurs in two forms: (1) water bound to ingredients in the food (proteins, salt, sugars), and (2) free or unbound water that is available for microbial growth. Water activity (Aw) describes water available for microbial growth and ranges from 0 (bone dry) to 1.0 (pure water)."
[more infor](https://www.clemson.edu/extension/food/canning/canning-tips/39available-moisture.html)

```{r resid22, echo=TRUE,message=FALSE,results = "asis"}

make_bins <- function(x,y,nbin){
  if (nbin==0)
    nbin <- floor(sqrt(length(x)))
  
  df <-
  data.frame(
    y = y,
    breaks = cut2(x,m=nbin,levels.mean=TRUE)
  )
  df <- df |> 
  dplyr::group_by(breaks) |> 
  dplyr::summarize(mean = mean(y),
            std = sd(y),
            cnt = n()
            ) |> dplyr::mutate(y_min=mean-1.96*std/sqrt(cnt), y_max = mean+1.96*std/sqrt(cnt))
  
  df$breaks <- as.numeric(as.character(df$breaks))
  
  df

}

plot_bins2<- function(df_list,xlab = "Moisture",ylab = "Binned Diff Residuals"){
  df <- do.call("rbind", df_list)
  df$Model <-
  rep(names(df_list), each = nrow(df_list[[1]]))
    
  g <- ggplot(df,aes(breaks,mean,color=Model)) + geom_point() +
    geom_errorbar(aes(ymin=y_min,ymax=y_max))+
  geom_smooth(aes(breaks,mean),se = FALSE)+
    scale_color_manual(values=c("#E69F00", "#56B4E9"))+
  ylab(ylab) + xlab(xlab) +
  theme_minimal()
  g
  
}


linear_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI'

ns_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(30, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) '
lm_base <- lm(as.formula(linear_model), data)
ns_base <- lm(as.formula(ns_model), data)


lm_mos_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI+ DR1TMOIS '

ns_mos_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(30, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) + DR1TMOIS'
lm_mos <- lm(as.formula(lm_mos_model), data)
ns_mos <- lm(as.formula(ns_mos_model), data)




mos_age_res <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=resid(lm_mos)-resid(lm_base),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=resid(ns_mos)-resid(ns_base), 
                                   nbin=600)
                )



mos_bmi_res <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=resid(lm_mos)-resid(lm_base),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=resid(ns_mos)-resid(ns_base), 
                                   nbin=600)
                )



g_age_mos_diff <- plot_bins2(mos_age_res,xlab="Age(years)") 

g_bmi_mos_diff <- plot_bins2(mos_bmi_res,xlab="BMI (kg/m²)")





mos_bmi_res_raw <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=resid(lm_mos),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=resid(ns_mos), 
                                   nbin=600)
                )



mos_age_res_raw <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=resid(lm_mos),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=resid(ns_mos), 
                                   nbin=600)
                )



g_age_res_raw <- plot_bins2(mos_age_res_raw,xlab="Age(years)",ylab="Binned Residual") 

g_bmi_res_raw <- plot_bins2(mos_bmi_res_raw,xlab="BMI (kg/m²)",ylab="Binned Residual")











lm_calc_model <- 'BPXDI1 ~ RIDAGEYR*RIAGENDR + BMXBMI+ DR1TCALC '
ns_calc_model <-
  'BPXDI1 ~ ns(RIDAGEYR, knots 
= seq(30, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10))) + DR1TCALC'
lm_calc <- lm(as.formula(lm_calc_model), data)
ns_calc <- lm(as.formula(ns_calc_model), data)

calc_age_res <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=resid(lm_calc)-resid(lm_base),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=resid(ns_calc)-resid(ns_base), 
                                   nbin=600)
                )



calc_bmi_res <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=resid(lm_calc)-resid(lm_base),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=resid(ns_calc)-resid(ns_base), 
                                   nbin=600)
                )


g_age_calc_diff <- plot_bins2(calc_age_res,xlab="Age (years)")

g_bmi_calc_diff <- plot_bins2(calc_bmi_res,xlab="BMI (kg/m²)") 


calc_age_res_raw <- list("Linear"=make_bins(x=data$RIDAGEYR,
                                      y=resid(lm_calc),
                                      nbin=600),
                "Spline"=make_bins(x=data$RIDAGEYR, 
                                   y=resid(ns_calc), 
                                   nbin=600)
                )



calc_bmi_raw <- list("Linear"=make_bins(x=data$BMXBMI,
                                      y=resid(lm_calc),
                                      nbin=600),
                "Spline"=make_bins(x=data$BMXBMI, 
                                   y=resid(ns_calc), 
                                   nbin=600)
                )


g_age_calc_raw <- plot_bins2(calc_age_res_raw,xlab="Age (years)",ylab="Binned Residual")

g_bmi_calc_raw <- plot_bins2(calc_bmi_raw,xlab="BMI (kg/m²)",ylab="Binned Residual") 


```


###  absolute of the difference residuals with or without dietary variables


- y-axis is binned difference residuals, and difference residuals are computed as $R_1-R_2$ ,where $R_1$ is residuals of base model (eg, BPXDI1 ~ RIDAGEYR\*RIAGENDR + BMXBMI), and $R_2$ residuals of model with dietary variables(eg, BPXDI1 ~ RIDAGEYR\*RIAGENDR + BMXBMI+DR1TMOIS).


- In panel <em><strong> a) </strong></em> and <em><strong> b) </strong></em>, the yellow lines show binned plots of differences residuals of linear model with or without DR1TMOIS, and the blue lines show binned plots of differences residuals of spline model with or without DR1TMOIS. The values are binned according to Age and BMI, and each bin contains about 600 points


- Similarly, panel <em><strong> c) </strong></em> and <em><strong> d) </strong></em>, show the binned residuals of the models with DR1TMOIS.



```{r cook_lev, echo=TRUE,message=FALSE,results = "asis",dpi = 200}


ggpubr::ggarrange(g_age_mos_diff ,g_bmi_mos_diff,
                  g_age_res_raw,g_bmi_res_raw,
                  common.legend = TRUE,
                  labels = c('a)','b)','c)','d)'),
                  legend="right")
```

And, the following the same plots but with DR1TCALC. 
Note that forest plot shows DR1TCALC has almost same estimator on the linear and spline model. However, the estimators for DR1TMOIS in linear and spline models are quite different.

```{r cook_lev2, echo=TRUE,message=FALSE,results = "asis",dpi = 200}
ggpubr::ggarrange(g_age_calc_diff,g_bmi_calc_diff,
                  g_age_calc_raw,g_bmi_calc_raw,
                  common.legend = TRUE,
                  labels = c('a)','b)','c)','d)'),
                  legend="right")
```




We compared the moisture impact on blood pressure with linear and spline regression.
[Jordan et al.](https://www.ahajournals.org/doi/pdf/10.1161/01.cir.101.5.504) suggest that water has the effect of increasing blood pressure in older
people; therefore, we also add models with moisture interacting with age for further comparison. The binned plots show all models have high leverage when DR1TMOIS greater than 1000, but they have less influence on the spline model than others. 







## Beta-carotene (0 to 116313 mcg): inverse normal transformation

"The human body converts beta carotene into vitamin A (retinol) – beta carotene is a precursor of vitamin A. We need vitamin A for healthy skin and mucus membranes, our immune system, and good eye health and vision." [more](https://www.medicalnewstoday.com/articles/252758#what_is_carotene)


"If the residual distribution is asymmetric (skewed) or heavy-tailed (kurtotic) relative to the normal distribution, then standard linear regression may fail to control the type I error in moderate samples. Even if the sample is sufficiently large for standard linear regression to provide valid inference, it is not fully efficient when the residual distribution is non-normal. "
[more](https://cran.r-project.org/web/packages/RNOmni/vignettes/RNOmni.html)


As we can see from the below plots, the DR1TBCAR distribution is highly skewed and has a long tail before being transformed. On the other hand, the altered distribution has a typical normal distribution, which is very different from the original distribution.




