---
title: "Pre EnWAS 3 (split plots for lines)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libs
```{r libs,warning=FALSE,message=FALSE}
library(splines)
library(stringr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(DBI)
```

## Load exploration

- `nhanes.sqlite` can download [here](https://github.com/ccb-hms/Imputation/blob/main/nhanes.sqlite) or generate by run [notebook](https://ccb-hms.github.io/Imputation/6_nhanes_data/nhanes_exploratory.html)

```{r data, echo=TRUE}

set.seed(123)

nhanes_db <- dbConnect(RSQLite::SQLite(), "../../nhanes.sqlite")

# list all of the tables
dbListTables(nhanes_db)

cols <- 'BMXWAIST , RIDAGEYR, BMXHT, BMXWT, BMXBMI, RIAGENDR, years, DR1TM161, WTDRD1, BMXLEG, BMXARML '
data_sql <- paste0('SELECT ', cols, 'FROM merged_table')


data <- dbGetQuery(nhanes_db, data_sql)
data <- na.omit(data)

dbDisconnect(nhanes_db)


train_ix <- sample(x = 1:nrow(data), size = 15000)
test_ix <- sample(x = setdiff(1:nrow(data), train_ix), 5000)

train_data <- data[train_ix, ]
test_data <- data[test_ix, ]
```

## Inverse Normal Distribution

```{r func, echo=TRUE}
invNorm <- function(x) {qnorm((rank(x) - 3/8)/(length(x) +1 - 6/8))}

mean_square_error <- function(y_true, y_pred){
    round(mean((y_true - y_pred)^2),4)
}


```




### Plot regression

It is challenging to select testing data to test the model by fixing some terms because data columns are not completely orthogonal to each other. As the previous version shows, simply fixing terms or using mean or median as the data could be biased.


```{r spline_test, echo=TRUE}

plot_base_model <-  function(var,
                             out = "BMXWAIST",
                             lm_mod,
                             test_set) {
  
  
  lm_pred <- predict(lm_mod, newdata = test_set, se = T)
   
  
  # save prediction results
  pred_df <- data.frame(
    x = test_set[,var],
    fit = lm_pred$fit,
    lower = lm_pred$fit - 1.96 * lm_pred$se.fit,
    upper = lm_pred$fit + 1.96 * lm_pred$se.fit,
    sex = test_set$RIAGENDR
  )
  
  
  
#plot results
  g <-
    ggplot(pred_df, aes(x = x, y = fit)) + 
    geom_line(aes(
      x = x,
      y = fit,
      colour = sex
    ), size = 1.5) +
    geom_ribbon(aes(ymin = lower, ymax = upper,colour = sex),alpha = 0.1)+
    ylab(out) + xlab(var)

  g
}




```


### regression models weight

`BMXWAIST ~ ns(RIDAGEYR, knots = seq(30, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = seq(30, 80, by = 10))`

```{r spline_test_weith, echo=TRUE}
lm_model <-
  lm(
    formula = BMXWAIST ~ ns(RIDAGEYR,knots = seq(30, 80, by = 10))*RIAGENDR + ns(BMXBMI,df=7),
    train_data
  )

cols <- c('RIDAGEYR','BMXBMI','RIDAGEYR')

test_set <- test_data

test_set$BMXBMI <- mean(test_set$BMXBMI,na.rm = TRUE)
  
plot_base_model(var="RIDAGEYR",lm_mod = lm_model,test_set = test_set)


test_set <- test_data

test_set$RIDAGEYR <- mean(test_set$RIDAGEYR,na.rm = TRUE)
  
plot_base_model(var="BMXBMI",lm_mod = lm_model,test_set = test_set)

```

