---
title: "EnWAS"

output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libs
```{r libs,warning=FALSE,message=FALSE}
library(DBI)
library(survey)
library(broom)
library(splines)
library(stringr)
library(dplyr)
library(ggplot2)

```

## Load exploration

- select_vars.txt was generated by [variable selection process](https://ccb-hms.github.io/Imputation/7_enwas/diet_var_selection.html)
- `nhanes.sqlite` can download [here](https://github.com/ccb-hms/Imputation/blob/main/nhanes.sqlite) or generate by run [notebook](https://ccb-hms.github.io/Imputation/6_nhanes_data/nhanes_exploratory.html)

```{r data, echo=TRUE}
source("../6_nhanes_data/phesant.R")

exposure_vars <-
  read.delim("../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../nhanes.sqlite")
  
  cols <-
    'BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  phs_res <- phesant(data)
  
  data[, names(phs_res[phs_res %in% c("ordered", "unordered", "binary")])] <-
    lapply(data[, names(phs_res[phs_res %in% c("ordered", "unordered", "binary")])], as.factor)
  
  data[, names(phs_res[phs_res == "continuous"])] <-
    lapply(data[, names(phs_res[phs_res == "continuous"])], as.numeric)
  
  return(list(data = data, phs_res = phs_res))
  
}

data_phs <- load_data(exposure_cols)

data <- data_phs$data
phs_res <- data_phs$phs_res

```


## Inverse Normal Distribution and build formula

```{r func, echo=TRUE}
invNorm <- function(x) {qnorm((rank(x) - 3/8)/(length(x) +1 - 6/8))}
min_max_norm <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}


build_formula <- function(base_model,exposure_var,inv=FALSE) {
  var <- "+ %s"
  if(inv) var <- " + invNorm(%s)" 
  
  as.formula(
    sprintf(paste0(base_model, var),
      exposure_var
    )
  )
}


```



## EnWAS

```{r func2, echo=TRUE}


enwas <- function(base_model, exposure_vars, data_set, inv_norm = FALSE) {
  
  num_var <-length(exposure_vars)
  
  model_list <- vector(mode = "list",length = num_var)
  num_cols <- sapply(data[,exposure_vars], is.numeric)
  num_cols <- names(num_cols[num_cols==TRUE])
  if(inv_norm){
    data_set[,num_cols] <- lapply(data_set[,num_cols],invNorm)
  }
  
  
  
  
  association_list <- data.frame() 
  factor_terms <- c() # to hold the factors terms
  num_var <- length(exposure_vars)
  for (i in 1:num_var) {
    exposure <- exposure_vars[i]
    
    if(is.factor(data_set[,exposure])) {
      factor_terms <- c(factor_terms, paste0(exposure,levels(data_set[,exposure])))
    }
      
    model <- build_formula(base_model, exposure)
  
    mod <- lm(model, data_set)
    model_list[[i]] <- mod
    mod_df <- tidy(mod)
    association_list <-
      rbind(association_list, mod_df) # step 3b of algorithm
  }
  
  
  xwas_list <-
    association_list[association_list$term %in% c(exposure_vars,factor_terms),]
  
  sd_x_list <-  sapply(data_set[,num_cols],sd)
  for(c in num_cols){
    xwas_list[xwas_list$term==c,c('estimate','std.error')] <- xwas_list[xwas_list$term==c,c('estimate','std.error')]*sd_x_list[c]
  }



  xwas_list$fdr <-
    p.adjust(xwas_list$p.value, method = 'BY')
  
  
  
  xwas_list <- xwas_list |>
    mutate(lower = estimate - 1.96 * std.error)  |>
    mutate(upper = estimate + 1.96 * std.error)
  
  return (list(model_list= model_list, enwas_res = xwas_list))
  
}




forest_plot <- function(xwas_result) {
  xwas_result |>
    ggplot(aes(
      x = term,
      y = estimate,
      ymin = lower,
      ymax = upper,
      colour = estimate
    )) +
    geom_pointrange() +
    coord_flip() +  # flip coordinates (puts labels on y axis)
    xlab("Exposures") + ylab("Estimate (95% CI)") +
    theme_bw()  # use a white background
}


forest_plot_mult <- function(xwas_result_list) {
  xwas_result <- do.call("rbind", xwas_result_list)
  xwas_result$EnWAS <-
    rep(names(xwas_result_list), each = nrow(xwas_result_list[[1]]))
  
  xwas_result |>
    ggplot(aes(
      x = term,
      y = estimate,
      ymin = lower,
      ymax = upper,
      colour = EnWAS
    )) +
    geom_pointrange(alpha = 0.4) +
    coord_flip() +  # flip coordinates (puts labels on y axis)
    xlab("Exposures") + ylab("Estimate (95% CI)") +
    theme_bw()  # use a white background
}


```


## EnWAS Results

```{r func3, echo=TRUE,warning=F}

linear_model <- 'BMXWAIST ~ RIDAGEYR+RIAGENDR + BMXBMI'
linear_res2 <- enwas(linear_model, exposure_vars, data)
forest_plot(linear_res2$enwas_res)


all_ns_model <-
  'BMXWAIST ~ ns(RIDAGEYR, knots = seq(30, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = seq(30, 80, by = 10))'
all_ns_res <- enwas(all_ns_model, exposure_vars, data)


forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    ns = all_ns_res$enwas_res
  )
)




lm_inverse_res <- enwas(linear_model, exposure_vars, data,inv = TRUE)
ns_inverse_res <- enwas(all_ns_model, exposure_vars, data,inv = TRUE)


forest_plot_mult(
  list(
    lm_inv = lm_inverse_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)
  
```
