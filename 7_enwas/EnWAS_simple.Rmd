---
title: "EnWAS simple version"

output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libs
```{r libs,warning=FALSE,message=FALSE}
library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)

```

## Load exploration

- select_vars.txt was generated by [variable selection process](https://ccb-hms.github.io/Imputation/7_enwas/diet_var_selection.html)
- `nhanes.sqlite` can download [here](https://github.com/ccb-hms/Imputation/blob/main/nhanes.sqlite) or generate by run [notebook](https://ccb-hms.github.io/Imputation/6_nhanes_data/nhanes_exploratory.html)

```{r data, echo=TRUE}
# source("../6_nhanes_data/phesant.R")

exposure_vars <-
  read.delim("../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../nhanes.sqlite")
  
  cols <-
    'BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types

```



## Run EnWAS 

```{r func3, echo=TRUE,warning=F, out.width = '90%'}
linear_model <- 'BMXWAIST ~ RIDAGEYR*RIAGENDR + BMXBMI'
linear_res2 <- enwas(linear_model, exposure_vars, data)


all_ns_model <-
  'BMXWAIST ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10)))'
all_ns_res <- enwas(all_ns_model, exposure_vars, data)


lm_inverse_res <- enwas(linear_model, exposure_vars, data,inv = TRUE)
ns_inverse_res <- enwas(all_ns_model, exposure_vars, data,inv = TRUE)


```


## Compare linear regression with spline regression.
In the following plot, EnWAS results with linear and spline base models as defined in the above section. Although the spline model does not significantly differ from the linear model in this dataset, we still observed some differences. For example, Eicosenoic (DR1TM201, 0 ~ 5.489 gm) false negative in the linear regression.


```{r res3, echo=TRUE,warning=F, out.width = '90%'}
# forest_plot(linear_res2$enwas_res)


forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    ns = all_ns_res$enwas_res
  )
)
```

## Post process the results for compare

```{r func31, echo=TRUE,warning=F, out.width = '90%'}
xwas_res_list <-
  list(
    linear = linear_res2$enwas_res,
    ns = all_ns_res$enwas_res,
    lm_inv = lm_inverse_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
xwas_result <- do.call("rbind", xwas_res_list)
xwas_result$EnWAS <-
  rep(names(xwas_res_list), each = nrow(xwas_res_list[[1]]))


xwas_result$postive <- xwas_result$lower * xwas_result$upper
xwas_result$postive <- xwas_result$postive >= 0.00001
num_cols <- sapply(data[, exposure_vars], is.numeric)
num_cols <- names(num_cols[num_cols == TRUE])
ns_vs_linear <-
  xwas_result[xwas_result$EnWAS == "linear", ]$postive != xwas_result[xwas_result$EnWAS ==
                                                                       "ns", ]$postive
```

## Variables that have different responses in linear and spline model

We can filter out the false positive or false negative responses with the above operation.
Eicosenoic (DR1TM201, 0 ~ 5.489 gm) is a false negative in the linear regression because people gent to consume less Eicosenoic after 60 and drop dramatically at 80, which is not linear with respect to age. (but why?)

Both models show that Lutein and zeaxanthin (DR1TLZ, 0~102251 mcg) negatively affect the outcome, but the spline model shows it has much less impact. Again, Lutein and zeaxanthin have a non-linear association with ages, especially between 20 to 30, because people do not pay too much attention to eye health at that age.

```{r res32, echo=TRUE,warning=F, out.width = '90%'}

num_cols[ns_vs_linear]

ggplot(data,
         aes(
           x = RIDAGEYR,
           y = invNorm(DR1TM201),
           colour = RIAGENDR
         )) +
  geom_point(alpha = 0.1) +
  geom_smooth(
    method = lm,
    formula = y ~ ns(x, knots = seq(20, 80, by = 10)),
    size = 1
  )

ggplot(data,
       aes(
           x = RIDAGEYR,
           y = invNorm(DR1TLZ),
           colour = RIAGENDR
       )) +
    geom_point(alpha = 0.1) +
    geom_smooth(
        method = lm,
        formula = y ~ ns(x, knots = seq(20, 80, by = 10)),
        size = 1
    )

# for (c in num_cols[ns_vs_linear]) {
#   g <-
#     ggplot(data,
#            aes_string(
#              x = "RIDAGEYR",
#              y = paste0("invNorm(", c, ")"),
#              colour = "RIAGENDR"
#            )) +
#     geom_point(alpha = 0.1) +
#     geom_smooth(
#       method = lm,
#       formula = y ~ ns(x, knots = seq(20, 80, by = 10)),
#       size = 1
#     )
#   print(g)
# }
```

```{r res4, echo=TRUE,warning=F, out.width = '90%'}
forest_plot_mult(
  list(
    lm_inv = lm_inverse_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)
forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    lm_inv = lm_inverse_res$enwas_res
  )
)
forest_plot_mult(
  list(
    ns = all_ns_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)
  
```




## EnWAS show interesting variables


```{r func_intes_var, echo=TRUE,results = "asis"}

# ns vs inverse norm transformation
ns_vs_ns_inv <-
  xwas_result[xwas_result$EnWAS == "ns_inv", ]$postive != xwas_result[xwas_result$EnWAS ==
                                                                        "ns", ]$postive
num_cols[ns_vs_ns_inv]

for (c in c(num_cols[ns_vs_ns_inv],'DR1TS120')) {
  par(mfrow = c(1, 2))
  hist(data[, c], main = c)
  hist(invNorm(data[, c]), main = paste0("invNorm:", c))
}

```

## Testing ethnicity Groups Linear Model
```{r enthic, echo=TRUE,results = "asis"}
ethnicity <- c('Mexican American','Other Hispanic','Non-Hispanic White','Non-Hispanic Black','Other Race')
lm_base <- lm(as.formula(linear_model),data)
lm_df <- data_frame(residuals=lm_base$residual,ethnicity = data$RIDRETH1,gender=data$RIAGENDR)
levels(lm_df$ethnicity) <- ethnicity
ggplot(lm_df, aes(x=ethnicity, y=residuals, fill=gender)) + geom_boxplot()+
  scale_x_discrete(guide = guide_axis(angle = 45)) 

```


## Testing ethnicity Groups Spline Model
```{r enthic2, echo=TRUE,results = "asis"}
ns_base <- lm(as.formula(all_ns_model),data)
ns_df <- data_frame(residuals=ns_base$residual,ethnicity = data$RIDRETH1,gender=data$RIAGENDR)
levels(ns_df$ethnicity) <- ethnicity
ggplot(ns_df, aes(x=ethnicity, y=residuals, fill=gender)) + geom_boxplot()+
  scale_x_discrete(guide = guide_axis(angle = 45)) 

```