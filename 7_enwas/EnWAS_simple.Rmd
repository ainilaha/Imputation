---
title: "EnWAS simple version"

output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libs
```{r libs,warning=FALSE,message=FALSE}
library(DBI)
# library(broom)
library(splines)
# library(stringr)
library(dplyr)
library(ggplot2)
library(EnWAS)

```

## Load exploration

- select_vars.txt was generated by [variable selection process](https://ccb-hms.github.io/Imputation/7_enwas/diet_var_selection.html)
- `nhanes.sqlite` can download [here](https://github.com/ccb-hms/Imputation/blob/main/nhanes.sqlite) or generate by run [notebook](https://ccb-hms.github.io/Imputation/6_nhanes_data/nhanes_exploratory.html)

```{r data, echo=TRUE}
# source("../6_nhanes_data/phesant.R")

exposure_vars <-
  read.delim("../data/select_vars.txt", header = FALSE)$V1
exposure_cols <- paste(exposure_vars, collapse = ", ")


# Load data and convert data types according to PHESEANT.
# Return data set and PHESEANT results.
load_data <- function(exposure_cols) {
  nhanes_db <- dbConnect(RSQLite::SQLite(), "../nhanes.sqlite")
  
  cols <-
    'BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,SDMVPSU,SDMVSTRA,RIDRETH1, years,'
  data_sql <-
    paste('SELECT', cols, exposure_cols, 'FROM merged_table')
  
  data <- dbGetQuery(nhanes_db, data_sql)
  data <- na.omit(data)
  dbDisconnect(nhanes_db)
  
  data
  
}

nhanes_data <- load_data(exposure_cols) 
data_phs <- phesant(nhanes_data)

data <- data_phs$data
phs_res <- data_phs$data_types

```



## Run EnWAS 

```{r func3, echo=TRUE,warning=F, out.width = '90%'}
linear_model <- 'BMXWAIST ~ RIDAGEYR*RIAGENDR + BMXBMI'
linear_res2 <- enwas(linear_model, exposure_vars, data)


all_ns_model <-
  'BMXWAIST ~ ns(RIDAGEYR, knots = seq(20, 80, by = 10)) * RIAGENDR + ns(BMXBMI,knots = c(seq(15, 45, by = 5),seq(45,65,by=10)))'
all_ns_res <- enwas(all_ns_model, exposure_vars, data)


lm_inverse_res <- enwas(linear_model, exposure_vars, data,inv = TRUE)
ns_inverse_res <- enwas(all_ns_model, exposure_vars, data,inv = TRUE)


```


## Compare linear regression with spline regression.
In the following plot, EnWAS results with linear and spline base models as defined in the above section. As shown in [the notebook](https://ccb-hms.github.io/Imputation/7_enwas/pre_try/EnWAS2_splines_data_distribution.html), the spline and linear models are not significantly different because the relations of waist circumference with age and BMI are close to linearity. Although the spline model does not significantly differ from the linear model in this dataset, we still observed some differences. 

For example, Eicosenoic (DR1TM201, 0 ~ 5.489 gm) false negative in the linear regression.


```{r res3, echo=TRUE,warning=F, out.width = '90%'}
# forest_plot(linear_res2$enwas_res)


forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    ns = all_ns_res$enwas_res
  )
)
```



## Variables that have different responses in linear and spline model

We can filter out the false positive or false negative responses with the above operation.
Eicosenoic (DR1TM201, 0 ~ 5.489 gm) is a false negative in the linear regression because people gent to consume less Eicosenoic after 60 and drop dramatically at 80, which is not linear with respect to age. (but why?)


Both models show that Lutein and zeaxanthin (DR1TLZ, 0~102251 mcg) negatively affect the outcome, but the spline model shows it has much less impact. Again, Lutein and zeaxanthin have a non-linear association with ages, especially between 20 to 30, because people do not pay too much attention to eye health at that age.

```{r res32, echo=TRUE,warning=F, out.width = '90%'}

ggplot(data,
         aes(
           x = RIDAGEYR,
           y = invNorm(DR1TM201),
           colour = RIAGENDR
         )) +
  geom_point(alpha = 0.1) +
   geom_smooth (
      method = lm,
      formula = y ~ x
      ) +
   geom_smooth(
        method = lm,
        formula = y ~ ns(x, knots = seq(20, 80, by = 10)),
        size = 1
    )

```

```{r res4, echo=TRUE,warning=F, out.width = '90%'}
forest_plot_mult(
  list(
    lm_inv = lm_inverse_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)
forest_plot_mult(
  list(
    linear = linear_res2$enwas_res,
    lm_inv = lm_inverse_res$enwas_res
  )
)
forest_plot_mult(
  list(
    ns = all_ns_res$enwas_res,
    ns_inv = ns_inverse_res$enwas_res
  )
)
  
```


