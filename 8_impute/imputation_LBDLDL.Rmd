---
title: "An Example of Imputation"
output: html_document
author: "Laha Ale, Robert Gentleman"
date: "Updated on : `r date()`"

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(splines)
library(ggplot2)
library(ggpubr)
library(phonto)
library(EnWAS)
library(knitr)
library(mice)

library(naniar)
library(visdat)
library(corrplot)

library(DT)

```


### Load data

#### search the targeted variable (LBDLDL)

The questionnaires from 1999 to 2004 are named different from the rest of the years, but the variable LBDLDL represents LDL-cholesterol (mg/dL) across all the years, which can be verified on the nhanes documents on there website; therefore, we can merge the data together.

```{r data}
nhanesSearchVarName('LBDLDL') |> DT::datatable()
```

#### merge and PHESANT-like process

```{r}
cholesterol_tables = nhanesSearchVarName('LBDLDL')$Questionnaire
dlblbl_df = unionQuery(cholesterol_tables,cols =c("LBXTR","LBDLDL","LBDTRSI","LBDLDLSI"))
demo_tables = nhanesSearchTableNames('DEMO')
demo_df = unionQuery(demo_tables,cols =c("RIDAGEYR","RIAGENDR","RIDRETH1","DMDEDUC2","years"))
demo_df = na.omit(demo_df)
data = merge(demo_df,dlblbl_df,by="SEQN")
BMItabs = nhanesSearchVarName('BMXBMI')$Questionnaire
tdf = unionQuery(BMItabs, cols=c("BMXBMI","BMXWT"))

data = merge(data, tdf, by="SEQN")
phs_dat = phesant(data)
data = phs_dat$data

##get whether or not they are using cholesterol lowering drugs
BPQtabs = nhanesSearchVarName("BPQ100D")$Questionnaire
tBPQ = unionQuery(BPQtabs, cols = c('BPQ080','BPQ060', 'BPQ090D','BPQ100D','Questionnaire'))
cholMeds = tBPQ$BPQ100D
cholMeds[tBPQ$BPQ080==2] = 2
cholMeds[tBPQ$BPQ060==2] = 2
cholMeds[tBPQ$BPQ090D==2] = 2
cholMeds = factor(cholMeds,levels=c("1","2"), labels=c("Yes","No"))
table(cholMeds,useNA="always")
tBPQ$cholMeds = cholMeds
tBPQ = tBPQ[,c("SEQN", "cholMeds")]
data = merge(data, tBPQ, by="SEQN")

DT::datatable(phs_dat$phs_res)
```
preprocessing the above data by remove exceptional values and translate gender and enthnicity variables.

```{r}
data = data[!data$LBDLDL==629,] # remove an exceptional value LBDLDL(9 ~ 375)
data = phonto::nhanesTranslate('DEMO_I', c('RIAGENDR', 'RIDRETH1', 'DMDEDUC2'), data=data) # convert gender and ethnicity to factors
levsED = levels(data$DMDEDUC2)
##examine them and then put into groupings <HS, HS and > HS
levels(data$DMDEDUC2) <- c(">HS","HS",">HS","<HS","<HS","DK","R")
levels(data$DMDEDUC2) <- c(">HS", "HS", "<HS",NA, NA)
```



#### Choose the covariates

Cykert et al [1] used 
`gender, race, age, hypertension, diabetes, smoking, and systolic blood pressure` to impute HDL and total cholesterol, and Gao et al [2] `race, education, and health insurance type` with adjusted variables, `gender and age`.

In our data the hypertension variable is missing and we want to impute it. For that we probably want to consider good models for hypertension. Somehow it seems odd that BMI was not in their model, and we will include it as it will likely be an important predictor for both hypertension and cholesterol.  What was the age range for the paper? We may want to do 40+, just because that is where high cholesterol and hypertension become more prevalent.

[1] Cykert S, DeWalt DA, Weiner BJ, Pignone M, Fine J, Kim JI. A population approach using cholesterol imputation to identify adults with high cardiovascular risk: a report from AHRQ's EvidenceNow initiative. J Am Med Inform Assoc. 2019 Feb 1;26(2):155-158. doi: 10.1093/jamia/ocy151. PMID: 30496426; PMCID: PMC6373981.

[2] Gao Y, Shah LM, Ding J, Martin SS. US Trends in Cholesterol Screening, Lipid Levels, and Lipid-Lowering Medication Use in US Adults, 1999 to 2018. J Am Heart Assoc. 2023 Feb 7;12(3):e028205. doi: 10.1161/JAHA.122.028205. Epub 2023 Jan 10. PMID: 36625302; PMCID: PMC9973640.


#### diabetes data

```{r}
diab_tables = nhanesSearchVarName("DIQ010")$Questionnaire
dia_df = unionQuery(diab_tables,cols = c("DIQ010", "DIQ160","DIQ070"))

## fasting glucose
fastgluc = nhanesSearchVarName("LBXGLU")$Questionnaire
gluc_df = unionQuery(fastgluc, cols="LBXGLU")
dia_df = merge(dia_df,gluc_df,by="SEQN")
# Glycohemoglobin
gly_tables = nhanesSearchVarName("LBXGH")$Questionnaire
gly_df = unionQuery(gly_tables, cols="LBXGH")
dia_df = merge(dia_df,gly_df,by="SEQN")

##on meds - 
dontskip = dia_df$DIQ010 == 1 | dia_df$DIQ010 == 3 | dia_df$DIQ160 == 1
hypoglycemicMeds = dia_df$DIQ070
hypoglycemicMeds[!dontskip] = 2 #No
hypoglycemicMeds = factor(hypoglycemicMeds,levels=c(1,2,7,9), labels=c("Yes", "No",NA,NA))
table(hypoglycemicMeds,useNA="always")
dia_df$hypoglycemicMeds = hypoglycemicMeds

dia_df$diabetes = dia_df$DIQ010 == "Yes" | dia_df$LBXGLU > 110 | dia_df$LBXGH > 6.5
barplot(table(dia_df$diabetes, useNA="always"))
```


#### Hypertension data

```{r}
# "Hypertension was defined as systolic blood pressure (SBP) ≥140 mm Hg, diastolic blood pressure ≥90mm Hg, or the use of antihypertensive medication. "
bpq_tables = nhanesSearchVarName('BPQ050A')$Questionnaire
bpq_df = unionQuery(bpq_tables,cols = c('BPQ050A','BPQ020','BPQ040A', 'BPQ060','BPQ080','BPQ100D'))

hypertensiveMeds = bpq_df$BPQ050A
hypertensiveMeds[bpq_df$BPQ020==2] = 2
hypertensiveMeds[bpq_df$BPQ040A==2] = 2
##need to fix up the hypertension variable or we get lots of missing values
#set up a dummy for the ones we want to change - also turn "Don't know" from BPQ020 into NA
#  gg = is.na(bpq_df$BPQ050A) & bpq_df$BPQ020==2
#  bpq50A = bpq_df$BPQ050A
#  bpq50A[gg] = 2
 #check it worked
 # table(bpq50A, bpq_df$BPQ050A, useNA="always")
table(hypertensiveMeds, useNA="always")  
bpq_df$hypertensiveMeds = hypertensiveMeds

bpx_tables = nhanesSearchVarName('BPXSY1')$Questionnaire
bpx_df = unionQuery(bpx_tables,cols = c("BPXSY1","BPXSY2","BPXDI1","BPXDI2"))
bpx_df$DIASTOLIC <- rowMeans(bpx_df[, c("BPXDI1", "BPXDI2")], na.rm=TRUE)
bpx_df$DIASTOLIC[is.na(bpx_df$BPXDI1) & is.na(bpx_df$BPXDI2)] = NA
bpx_df$SYSTOLIC <- rowMeans(bpx_df[, c("BPXSY1", "BPXSY2")], na.rm=TRUE)
bpx_df$SYSTOLIC[is.na(bpx_df$BPXSY1) & is.na(bpx_df$BPXSY2)] = NA


bpx_df = merge(bpx_df,bpq_df,by="SEQN")

bpx_df$hypertension <- bpx_df$DIASTOLIC >= 90 | bpx_df$SYSTOLIC >= 140 |  bpx_df$hypertensiveMeds==1
barplot(table(bpx_df$hypertension, useNA="always"))
```


#### smoking data

In the code chunk below we extract the smoking data, and then try to create the groupings
used in the paper.  They have three groups, non-smokers, current smokers and ex-smokers. We use the `SMQ_I` and `SMQ_J` tables. We will define non-smoker as someone who as never smoked more than 100 cigarettes (`SMQ020`), anyone who has smoked more will be either
a current smoker or an ex-smoker (`SMQ040`)

```{r}
smoke_tables = nhanesSearchVarName('SMQ020')$Questionnaire
smoke_df = unionQuery(smoke_tables,cols = c("SMQ020","SMQ040"))

nhanesTranslate("SMQ_J", colnames=c("SMQ020","SMQ040"))
smokingVar = ifelse(smoke_df$SMQ020==2, "Non-smoker", ifelse(smoke_df$SMQ040==3, "Ex-smoker",
                    "Smoker"))
smoke_df$smoking = smokingVar
barplot(table(smokingVar, useNA="always"))
```



#### merge data and show the missingness
We merged the demographic data with information on diabetes, hypertension, and smoking data. Additionally, we demonstrate the missingness of the data by columns.

```{r}
data = merge(data,dia_df[,c('SEQN','diabetes')], by="SEQN")
data = merge(data,bpx_df[,c('SEQN','hypertension','SYSTOLIC')], by="SEQN")
data = merge(data,smoke_df[,c('SEQN','smoking')], by="SEQN")
sapply(data, function(x) sum(is.na(x)))
```

The plot below illustrates the missingness pattern, indicating that the hypertension column has a considerable number of missing values, with a higher proportion of missing values among the younger age population.

```{r}
gg_miss_fct(data,fct = RIDAGEYR)
```
The plot below shows the correlation among the missing values, and it indicates that there is no significant correlation between the missingness of hypertension and the other columns.

```{r}

missing_cols = sapply(data, function(x)sum(is.na(x)))
missing_cols = missing_cols[missing_cols>0] # select the data with missing values

correlation = cor(is.na(data[,names(missing_cols)]))
corrplot(correlation, type = "upper", order = "hclust",
         tl.col = "black", tl.srt = 45)

```

### split traning and testing data

At this point, we have excluded hypertension from our analysis due to the excessive amount of missing values it contains. Additionally, to validate the regression or imputation models, we have eliminated the records that contain missing values.

```{r}
data = data[,c("SEQN","RIDAGEYR","RIAGENDR" , "RIDRETH1" , "DMDEDUC2" ,"LBDLDL" ,"diabetes" ,"SYSTOLIC" ,"smoking","BMXBMI","BMXWT", "cholMeds")]
data_clean = na.omit(data)
data_clean = data_clean[data_clean$RIDAGEYR>49,]
# data = data[data$RIDAGEYR>40,] # remove age below 40 
# split training and testing data set
test_ix = sample(x = 1:nrow(data_clean), size = 15000) # about 10%
train_ix = sample(x = setdiff(1:nrow(data_clean), test_ix), size=110000)

train_data = data_clean[train_ix, ]
test_data = data_clean[test_ix, ]

MSE <- function(y_true, y_pred){
    mean((y_true - y_pred)^2)
}
```

## Imputation
To apply EnWAS methods for uncovering new covariates, it is necessary to confirm that the covariates introduced in the previous papers are suitable for predicting or imputing the target values. However, the imputation results were not satisfactory, as evaluated by mean square error. We also present a scatter plot to visualize the predicted values in relation to the true values.



## chatGPT-4

As we tested none of the abovementioned variable shows strong association or indicate to predict/impute LDL-cholesterol levels. So, we turn to chatgpt, and it gives us the following.

"
There are several factors that may be associated with LDL-cholesterol levels. Some of these factors include:

- Age: LDL-cholesterol levels tend to increase as people get older.
- Sex: Men often have higher LDL-cholesterol levels than women until about age 50, after which women's LDL-cholesterol levels may surpass men's.
- Genetics: A family history of high cholesterol can predispose individuals to elevated LDL-cholesterol levels.
- Diet: Diets high in saturated fat, trans fat, and cholesterol can contribute to increased LDL-cholesterol levels.
- Body weight: Overweight and obesity are associated with higher LDL-cholesterol levels.
- Physical activity: Regular exercise can help lower LDL-cholesterol levels.
- Smoking: Cigarette smoking can negatively impact LDL-cholesterol levels.
- Alcohol consumption: Moderate alcohol intake may have a protective effect on LDL-cholesterol, while excessive consumption can have the opposite effect.
- Medical conditions: Certain medical conditions, such as diabetes, hypothyroidism, and kidney disease, can contribute to elevated LDL-cholesterol levels.
- Medication use: Some medications, like certain Medication use: Some medications, like certain diuretics and beta-blockers, can adversely affect LDL-cholesterol levels."
```{r}
mod = lm(formula = LBDLDL ~ ns(RIDAGEYR, df=7) + cholMeds + RIAGENDR, data=data_clean) 
mod = lm(formula = LBDLDL ~ ns(BMXBMI, df=7) + cholMeds + RIAGENDR, data=data_clean)  
mod = lm(formula = LBDLDL ~ DMDEDUC2 + cholMeds, data=data_clean)  
mod = lm(formula = LBDLDL ~ ns(BMXWT, df=7) + cholMeds, data=data_clean) 
mod = lm(formula = LBDLDL ~ smoking, data=data_clean) 
```
#### Diet
Let's try to add diet as ChatGPT suggestion
```{r}
# saturated fat
# fat_tb = nhanesSearchVarName("DR1TSFAT")$Questionnaire
# fat_df = unionQuery(fat_tb, cols="DR1TSFAT")
# data = merge(data,fat_df,by="SEQN")
# mod = lm(formula = LBDLDL ~ ns(BMXWT, df=7) + cholMeds+smoking, data=data[data$RIDAGEYR>50,])
# summary(mod)
```




#### regression model

```{r}
lm_reg = lm(formula = LBDLDL ~ ns(RIDAGEYR, df=7) + cholMeds +RIAGENDR + RIDRETH1+DMDEDUC2+smoking+SYSTOLIC, data = train_data)

pred_data = predict(lm_reg, newdata = test_data)
mse = MSE(test_data$LBDLDL,pred_data)
qplot(test_data$LBDLDL,pred_data) +labs(title=paste("MSE=",round(mse,2)),
        x ="True Values", y = "Predicted Values")
```


#### nnet model
```{r}
library(nnet)
nn <- nnet(LBDLDL ~ RIDAGEYR+ cholMeds +RIAGENDR + RIDRETH1+DMDEDUC2+smoking+SYSTOLIC,
                data = train_data, size=3,hidden = c(8, 8,4),
                linear.output = TRUE)

pred_data = predict(nn, newdata = test_data) 
mse = MSE(test_data$LBDLDL,pred_data)
qplot(test_data$LBDLDL,pred_data) +labs(title=paste("MSE=",round(mse,2)),
        x ="True Values", y = "Predicted Values")
```


#### MICE

```{r}
# train_data = head(train_data,3000)
# train_data[test_ix[1:3000],"LBDLDL"]=NA
# train_data$SEQN=NULL
# 
# imp <-  mice(train_data, print=F)
# meth <- imp$meth
# meth[c("RIDAGEYR","RIAGENDR" ,"cholMeds", "RIDRETH1" , "DMDEDUC2" ,"LBDLDL" ,"diabetes" ,"SYSTOLIC" ,"smoking")]="cart"
# imp <- mice(train_data, m=1, method = meth, print=F)
# imp20  <-  mice.mids(imp, maxit=10, print=F)
# 
# complete_data <- mice::complete(imp20,action=1)
# qplot(test_data$LBDLDL,complete_data[test_ix[1:3000],"LBDLDL"]) +labs(title=paste("MSE=",round(mse,2)),
#         x ="True Values", y = "Predicted Values")
```


