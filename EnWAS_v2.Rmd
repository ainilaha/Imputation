---
title: "EnWAS V2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libs
```{r libs,warning=FALSE,message=FALSE}
library(DBI)
library(survey)
library(broom)
library(splines)
library(stringr)
library(dplyr)
library(ggplot2)

```

## Load exploration

- select_vars.txt was generated by [variable selection process](https://ccb-hms.github.io/Imputation/diet_var_selection.html)
- `nhanes.sqlite` can download [here](https://github.com/ccb-hms/Imputation/blob/main/nhanes.sqlite) or generate by run [notebook](https://ccb-hms.github.io/Imputation/nhanes_exploratory.html)

```{r data, echo=TRUE}


exposure_vars <- read.delim("data/select_vars.txt",header = FALSE)$V1
exposure_clap <- paste(exposure_vars,collapse=", ")


nhanes_db <- dbConnect(RSQLite::SQLite(), "nhanes.sqlite")

# list all of the tables
dbListTables(nhanes_db)

cols <- 'BMXWAIST, RIDAGEYR, BMXHT, BMXBMI, BMXWT, RIAGENDR,'
data_sql <- paste('SELECT', cols, exposure_clap,'FROM merged_table')

dbListTables(nhanes_db)

data <- dbGetQuery(nhanes_db, data_sql)
data <- na.omit(data)


dbDisconnect(nhanes_db)


# train_ix <- sample(x = 1:nrow(data), size = 6000)
# test_ix <- sample(x = setdiff(1:nrow(data), train_ix), 3000)
# 
# train_data <- data[train_ix, ]
# test_data <- data[test_ix, ]
```


## Inverse Normal Distribution and build formula

```{r func, echo=TRUE}
invNorm <- function(x) {qnorm((rank(x) - 3/8)/(length(x) +1 - 6/8))}
min_max_norm <- function(x) {
  (x - min(x)) / (max(x) - min(x))
}




build_formula <- function(base_model,exposure_var) {
  as.formula(
    sprintf(base_model,
      exposure_var
    )
  )
}


```



## EnWAS

```{r func2, echo=TRUE}


dsn <- svydesign(ids = ~ 0,
                 weights = ~ RIDAGEYR,
                 strata = ~ RIAGENDR,
                 data = data)






enwas <- function(base_model,exposure_vars, dsn){
  association_list <- data.frame() # step 2 of algorithm
  
  for(exposure in exposure_vars) {
  model <- build_formula(base_model, exposure)
  #print(model)
  ## now run the association
  mod <- svyglm(model, dsn) # step 3a
  mod_df <- tidy(mod)
  mod_df$variable <- exposure
  association_list <- rbind(association_list, mod_df) # step 3b of algorithm
  }
  
  # process results
  xwas_association_list <- association_list[association_list$term %in% exposure_vars, ]
  xwas_association_list$fdr <- p.adjust(xwas_association_list$p.value, method='BY')
  xwas_association_list <- xwas_association_list |> 
                        mutate(coff = estimate*std.error)  |>
                        mutate(lower = estimate-1.96*std.error)  |>
                        mutate(upper = estimate+1.96*std.error)
  
  xwas_association_list
  
}

forest_plot <- function(xwas_result){
  xwas_result |>
  ggplot(aes(x=variable, y=estimate, ymin=lower, ymax=upper,colour=estimate)) +
          geom_pointrange() + 
          # geom_hline(yintercept=1, lty=2) +  # add a dotted line at x=1 after flip
          coord_flip() +  # flip coordinates (puts labels on y axis)
          xlab("Exposures") + ylab("Estimate (95% CI)") +
          theme_bw()  # use a white background
}


```


## EnWAS Results

```{r func3, echo=TRUE,warning=F}
base_model <- 'BMXWAIST ~ bs(RIDAGEYR, df = 7)*RIAGENDR + bs(BMXWT) + BMXHT + %s'
enwas_res <- enwas(base_model,exposure_vars,dsn)
forest_plot(enwas_res)


base_model <- 'BMXWAIST ~ RIDAGEYR*RIAGENDR + BMXWT + BMXHT + %s'
enwas_res <- enwas(base_model,exposure_vars,dsn)
forest_plot(enwas_res)


base_model <- 'BMXWAIST ~ RIDAGEYR + RIAGENDR + BMXWT + BMXHT + %s'
enwas_res <- enwas(base_model,exposure_vars,dsn)
forest_plot(enwas_res)


age_knots <- seq(10, 90, by = 10)
q <- 10
bmi_knots = quantile(unique(data$BMXBMI),1:(q-2)/(q-1))

base_model <- 'BMXWAIST ~ ns(RIDAGEYR, knots = seq(10, 90, by = 10), Boundary.knots = c(10, 120)) * RIAGENDR + ns(BMXBMI) + BMXWT + BMXHT + %s'

enwas_res <- enwas(base_model,exposure_vars,dsn)
forest_plot(enwas_res)
  
```


